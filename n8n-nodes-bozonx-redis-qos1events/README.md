# n8n Nodes: Redis Pub / Redis Sub

Community nodes for n8n to work with Redis Streams:

- **Redis Pub**: Append events to a Redis Stream via XADD
- **Redis Sub**: Emit items when events appear in a Redis Stream via XREAD

[n8n](https://n8n.io/) is a [fair-code licensed](https://docs.n8n.io/sustainable-use-license/) workflow automation platform.

## Table of Contents

- [Installation](#installation)
- [Quick Start](#quick-start)
- [How it works](#how-it-works)
- [Redis Pub Parameters](#redis-pub-parameters)
- [Redis Sub Parameters](#redis-sub-parameters)
- [Credentials](#credentials)
- [Output Format](#output-format)
- [Testing locally](#testing-locally)
- [Compatibility](#compatibility)
- [Notes](#notes)
- [Development](#development)
- [Examples](#examples)
- [Troubleshooting](#troubleshooting)
- [Version](#version)
- [License](#license)

## Installation

Follow the official community nodes installation guide: https://docs.n8n.io/integrations/community-nodes/installation/

Package name: `n8n-nodes-bozonx-redis-qos1events`

Install via n8n UI:
- Open n8n → Settings → Community Nodes → Install
- Search for `n8n-nodes-bozonx-redis-qos1events` and install

## Quick Start

1. Start local Redis services:
   - In this package folder, run: `docker compose up -d`
2. Create credentials in n8n (type: `Redis (Streams)`):
   - Host: `localhost`
   - Port: `6379`
   - Password: `redispass` (from compose)
   - TLS: `false`
   - DB Index: `0`
3. Produce an event:
   - Add nodes: Manual Trigger → Redis Pub
   - Set Event name: `mystream`
   - Payload Mode: `Text`, Payload: `Hello from n8n`
4. Consume events:
   - Create a second workflow with `Redis Sub`
   - Event name: `mystream`
   - Allowed Stale (Seconds): `60` (to also read recent events)

## How it works

### Redis Pub (Producer)

The node writes messages to a Redis Stream via the `XADD` command:

- Messages are automatically assigned IDs using `*` (auto-generated by Redis)
- Stream trimming is enabled with `MAXLEN ~ 1000000` (approximate, keeps up to 1M messages)
- Stream TTL is set to 86400 seconds (24 hours) using `EXPIRE`
- Supports three payload modes: Text, JSON, and Key-Value

### Redis Sub (Trigger)

The node reads messages from a Redis Stream via the `XREAD` command:

- Uses blocking reads with 10-second timeout (`BLOCK 10000`)
- Reads up to 50 messages per batch (`COUNT 50`)
- Persists the last read message ID in workflow static data for resumption
- Automatically type-converts string values to appropriate types (number, boolean, null, JSON objects)
 - Manual run: using "Execute Node" performs a one-time `XREAD` with the same parameters

### Delivery Semantics

For "at-least-once" delivery guarantees:
- Redis Consumer Groups (`XREADGROUP`/`XACK`) are NOT implemented by this node. Current trigger uses `XREAD`.
- If you need group-based delivery/acknowledgements, use external consumers or fork/extend this node.
- The producer only appends once; Redis can deliver to multiple independent consumer groups when used.

## Redis Pub Parameters

### Event name
- **Type**: String (required)
- **Description**: Redis Stream key to append messages to
- **Example**: `my-service:main`

### Payload Mode
- **Type**: Options (required)
- **Default**: `Text`
- **Options**:
  - **Text**: Send a single field named `payload` containing the provided text
  - **JSON**: Send a single field named `data` containing JSON.stringify of the provided or incoming item
  - **Key-Value**: Send key-value pairs defined in the UI (input item JSON is not used)

### Payload
- **Type**: String or Collection (depends on Payload Mode)
- **For Text mode**: Text content sent as-is in field `payload`
- **For JSON mode**: Valid JSON string (or leave empty to use the incoming item JSON)
- **For Key-Value mode**: Collection of key-value pairs with the following fields:
  - **Key**: Field name (string)
  - **Type**: Value type (string, number, boolean, JSON, null)
  - **Value**: Field value (validated and serialized according to type)

## Redis Sub Parameters

### Event name
- **Type**: String (required)
- **Description**: Redis Stream key to read messages from
- **Example**: `my-service:main`

### Allowed Stale (Seconds)
- **Type**: Number
- **Default**: `0`
- **Description**: 
  - If `> 0`: On startup, also emit messages that are at most this many seconds old
  - If `0`: Only emit new messages after the trigger starts

## Credentials

Use the `Redis (Streams)` credentials with the following fields:

- **Host** (string, required)
  - Redis host name or IP address
  - Default: `localhost`

- **Port** (number, required)
  - Redis TCP port number
  - Default: `6379`

- **Username** (string, optional)
  - Redis ACL username
  - Leave empty if not required

- **Password** (string, optional)
  - Password for authentication
  - Leave empty if not required

- **TLS** (boolean)
  - Enable TLS/SSL encryption for the connection
  - Default: `false`

- **DB Index** (number)
  - Database index number
  - Default: `0`

## Output Format

Both nodes output items with the following structure:

```json
{
  "payload": <parsed_payload>,
  "_stream": "my-service:main",
  "_id": "1234567890123-0"
}
```

### Payload Parsing

**For Text mode:**
- `payload` contains the text string

**For JSON mode:**
- If the `data` field contains a JSON object, it's parsed and returned as `payload`
- If it's a primitive value, it's wrapped: `{ "value": <primitive> }`
- If parsing fails, returns: `{ "data": "<raw_string>" }`

**For Key-Value mode:**
- `payload` contains an object with typed key-value pairs
- Automatic type conversion from strings:
  - `"true"` / `"false"` → boolean
  - `"null"` → null
  - Valid numbers → number
  - JSON objects/arrays → parsed objects/arrays
  - Everything else → string

## Examples

### 1) Text mode (Producer → Trigger)

Producer configuration:
- Event name: `mystream`
- Payload Mode: `Text`
- Payload: `Hello from n8n`

Trigger output item:
```json
{
  "payload": "Hello from n8n",
  "_stream": "mystream",
  "_id": "1728666000000-0"
}
```

### 2) JSON mode using incoming item

Producer configuration:
- Event name: `mystream`
- Payload Mode: `JSON`
- Payload: (leave empty to use incoming item JSON)

Incoming item:
```json
{ "userId": 42, "active": true, "tags": ["a", "b"] }
```

Trigger output item:
```json
{
  "payload": { "userId": 42, "active": true, "tags": ["a", "b"] },
  "_stream": "mystream",
  "_id": "1728666000001-0"
}
```

## Testing locally

You can use the provided Docker Compose file to spin up Redis and RedisInsight:

1. Start Redis:
   ```bash
   docker compose up -d
   ```

2. Test with redis-cli (password from compose is `redispass`):
   ```bash
   # Create a consumer group (optional, for testing XREADGROUP)
   redis-cli -a redispass XGROUP CREATE mystream mygroup $ MKSTREAM

   # Read from the group
   redis-cli -a redispass XREADGROUP GROUP mygroup c1 COUNT 10 STREAMS mystream >

   # Acknowledge messages
   redis-cli -a redispass XACK mystream mygroup <message-id>
   ```

3. RedisInsight UI is available at http://localhost:5540

## Compatibility

Built and tested with n8n `1.60.0+`.

## Notes

- **MAXLEN**: Uses the approximate form `~` for better performance. The stream is trimmed to approximately 1,000,000 messages.
- **TTL**: Streams expire after 24 hours (86400 seconds) of inactivity.
- **Message IDs**: Auto-generated by Redis (using `*`). The format is `<timestamp-ms>-<sequence>`.
- **Trimming risk**: If consumers fall behind and MAXLEN is reached, older messages may be trimmed before processing.
- **Delivery guarantees**: Exact once-only delivery is not guaranteed by Redis Streams. Use idempotent logic if needed.
- **Continue On Fail**: Supported in node settings. On error, returns `{ "error": "<message>" }` and continues processing.
- **Empty Key-Value**: If no key-value pairs are provided in Key-Value mode, a marker field `__empty: "true"` is added (and filtered out by the subscriber).

## Troubleshooting

- Connection/auth errors
  - Verify Host/Port/Password in `Redis (Streams)` credentials
  - With the provided compose, password is `redispass`
- No items emitted by Redis Sub
  - By default, it starts from `$` (only new events). Set "Allowed Stale (Seconds)" > 0 to read recent history
  - Check stream key matches the producer's Event name
  - Stream may have expired (TTL 86400s) or been trimmed (MAXLEN ~ 1,000,000)
- Values are all strings
  - The trigger applies best-effort type parsing; ensure the producer uses JSON mode or appropriate types in Key-Value mode for exact typing

## Version

Package: `n8n-nodes-bozonx-redis-qos1events` — version 0.4.0

## License

MIT

## Development

Scripts:
- Build: `pnpm build`
- Dev (watch): `pnpm build:watch`
- Lint: `pnpm lint` / `pnpm lint:fix`

Release (for maintainers):
- `pnpm release` (uses @n8n/node-cli)

## Resources

- [Redis Streams Documentation](https://redis.io/docs/data-types/streams/)
- [n8n Community Nodes](https://docs.n8n.io/integrations/community-nodes/)
- [Repository](https://github.com/bozonx/ivan-k-automation-tools/tree/main/n8n-nodes-bozonx-redis-qos1events)
