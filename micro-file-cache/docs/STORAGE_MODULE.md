# StorageModule - Модуль файлового хранилища

## Обзор

StorageModule реализует функционал для работы с файловым хранилищем в микросервисе micro-file-cache. Модуль обеспечивает сохранение, чтение, удаление файлов с поддержкой дедупликации и автоматической организации по датам.

## Компоненты

### StorageService

Основной сервис для работы с файловым хранилищем.

#### Основные возможности:

1. **Сохранение файлов** (`saveFile`)
   - Валидация размера файла
   - Безопасное определение MIME типа через file-type
   - Опциональная валидация MIME типов (если настроена)
   - Дедупликация файлов по SHA-256 хешу
   - Организация файлов по датам (YYYY-MM)
   - Генерация безопасных имен файлов

2. **Получение информации о файлах** (`getFileInfo`)
   - Получение метаданных файла по ID
   - Проверка истечения срока жизни (TTL)

3. **Чтение файлов** (`readFile`)
   - Чтение содержимого файла по ID
   - Возврат буфера данных

4. **Удаление файлов** (`deleteFile`)
   - Удаление файла с диска
   - Обновление метаданных

5. **Поиск файлов** (`searchFiles`)
   - Фильтрация по MIME типу, размеру, дате
   - Поиск истекших файлов
   - Пагинация результатов

6. **Статистика** (`getFileStats`)
   - Общее количество файлов
   - Общий размер
   - Группировка по MIME типам и датам

7. **Состояние хранилища** (`getStorageHealth`)
   - Проверка доступности
   - Информация о дисковом пространстве
   - Количество файлов

#### Конфигурация:

- `STORAGE_BASE_PATH` - базовый путь к хранилищу (по умолчанию: `./storage`)
- `MAX_FILE_SIZE` - максимальный размер файла (по умолчанию: 100MB)
- `ALLOWED_MIME_TYPES` - разрешенные MIME типы (пустой массив = разрешены все типы)
- `DATE_FORMAT` - формат организации по датам (по умолчанию: `YYYY-MM`)
- `ENABLE_DEDUPLICATION` - включение дедупликации (по умолчанию: `true`)

### StorageModule

NestJS модуль, который экспортирует StorageService для использования в других модулях.

## Структура хранилища

```
storage/
├── data.json          # Метаданные всех файлов
└── 2024-01/           # Файлы за январь 2024
    ├── uuid1_file1.jpg
    └── uuid2_file2.pdf
└── 2024-02/           # Файлы за февраль 2024
    └── uuid3_file3.txt
```

## Метаданные (data.json)

```json
{
  "version": "1.0.0",
  "lastUpdated": "2024-01-15T10:30:00.000Z",
  "totalFiles": 3,
  "totalSize": 1024000,
  "files": {
    "uuid1": {
      "id": "uuid1",
      "originalName": "file1.jpg",
      "storedName": "uuid1_file1_abc123.jpg",
      "mimeType": "image/jpeg",
      "size": 512000,
      "hash": "sha256hash...",
      "uploadedAt": "2024-01-15T10:00:00.000Z",
      "ttl": 3600,
      "expiresAt": "2024-01-15T11:00:00.000Z",
      "filePath": "/storage/2024-01/uuid1_file1_abc123.jpg",
      "metadata": {}
    }
  }
}
```

## Безопасность

1. **Опциональная валидация MIME типов** - можно настроить ограничения или разрешить все типы
2. **Ограничение размера** - защита от больших файлов
3. **Безопасные имена файлов** - очистка от опасных символов
4. **Хеширование** - SHA-256 для дедупликации и проверки целостности
5. **Безопасное определение MIME типа** - использование file-type для точного определения типа

## Дедупликация

При включенной дедупликации:

- Файлы с одинаковым SHA-256 хешем сохраняются только один раз
- При повторной загрузке того же файла возвращается ссылка на существующий
- Обновляется время истечения срока жизни

## Тестирование

Созданы unit тесты для проверки:

- Инициализации хранилища
- Получения статистики и состояния
- Поиска файлов
- Обработки ошибок

## Использование

```typescript
import { StorageService } from './modules/storage/storage.service';

@Injectable()
export class SomeService {
  constructor(private readonly storageService: StorageService) {}

  async uploadFile(file: UploadedFile, ttl: number) {
    const result = await this.storageService.saveFile({
      file,
      ttl,
      metadata: { source: 'api' },
    });

    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.error);
    }
  }
}
```

## Примеры конфигурации

### Разрешить все типы файлов (по умолчанию)

```env
ALLOWED_MIME_TYPES=
```

### Ограничить только изображениями

```env
ALLOWED_MIME_TYPES=["image/jpeg","image/png","image/gif","image/webp"]
```

### Ограничить только документами

```env
ALLOWED_MIME_TYPES=["application/pdf","text/plain","application/json","text/csv"]
```

## Следующие этапы

StorageModule готов для интеграции в основное приложение на этапе 6. Модуль предоставляет все необходимые методы для работы с файлами и может быть использован в FilesService и FilesController.
